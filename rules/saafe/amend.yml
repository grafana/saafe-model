groups:
  - name: SAAFEAmend
    rules:

    # track otel service versions
    - record: saafe:version:info
      expr: |-
        group by (job, version) (
          label_replace(
              traces_target_info{job!="", service_version!=""}
                or
              target_info{job!="", service_version!=""},
            "version", "$1", "service_version", "(.+)"
          )
        )
      labels:
        saafe_version_type: service

    # track prometheus exporter versions
    - record: saafe:version:info
      expr: |-
        group by (job, version, saafe_source) (
          label_replace({__name__=~"[A-Za-z_]*exporter_build_info", version != ""}, "saafe_source", "$1", "__name__", "([A-Za-z_]*exporter)_build_info")
        )
      labels:
        saafe_version_type: exporter

    # track runtime version changes
    - record: saafe:version:info
      expr: group by (job, version) (go_info)
      labels:
        saafe_version_type: runtime
        saafe_source: golang

    - record: saafe:version:info
      expr: group by (job, version) (python_info)
      labels:
        saafe_version_type: runtime
        saafe_source: python

    - record: saafe:version:info
      expr: group by (job, version) (jvm_info)
      labels:
        saafe_version_type: runtime
        saafe_source: jvm

    - record: saafe:release:versions
      expr: |
        count by(job, saafe_version_type, saafe_source)(
          count_over_time(
            count by(job, version, saafe_version_type, saafe_source)(
              saafe:version:info
            )[5m:1m]
          )
        )

      ################################################################
      #                        Alerts                                #
      ################################################################

    - alert: "VersionUpdated"
      expr: ceil(deriv(saafe:release:versions[5m])) > 0
      labels:
        saafe_category: amend
        saafe_severity: info
