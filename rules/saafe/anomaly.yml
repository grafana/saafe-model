groups:
  - name: SAAFEAnomaly
    rules:

      ####################################################################################
      #                                Spanmetrics                                       #
      ####################################################################################

    - record: anomaly:request:rate5m
      expr: sum(rate(traces_span_metrics_duration_milliseconds_count{span_kind=~"SPAN_KIND_SERVER|SPAN_KIND_CONSUMER"}[5m])) by (job)
      labels:
        anomaly_name: "otel_demo_requests"
        anomaly_type: "requests"
        anomaly_strategy: "robust"

    - record: anomaly:request:latency:p95
      expr: histogram_quantile(0.95, sum by (job, le) (rate(traces_span_metrics_duration_milliseconds_bucket{span_kind=~"SPAN_KIND_SERVER|SPAN_KIND_CONSUMER"}[5m])))
      labels:
        anomaly_name: "otel_demo_latency_p95"
        anomaly_type: "latency"
        anomaly_strategy: "robust"

      ####################################################################################
      #                               Node Exporter                                      #
      ####################################################################################

    - record: anomaly:resource:cpu
      expr: |-
        (((count by (instance, job) (count(node_cpu_seconds_total{job=~"node_exporter"}) by (cpu, instance, job))) 
        -
        avg by (instance, job) (sum by (instance, mode, job)(irate(node_cpu_seconds_total{mode='idle',job=~"node_exporter"}[5m])))) * 100) 
        /
        count by(instance, job) (count(node_cpu_seconds_total{job=~"node_exporter"}) by (cpu, instance, job))
      labels:
        anomaly_name: "node_cpu"
        anomaly_type: "resource"
        anomaly_strategy: "robust"

    - record: anomaly:resource:memory
      expr: |-
        100 -
        (
          avg by (instance, job) (node_memory_MemAvailable_bytes{job=~"node_exporter"}) /
          avg by (instance, job) (node_memory_MemTotal_bytes{job=~"node_exporter"})
        * 100
        )
      labels:
        anomaly_name: "node_memory"
        anomaly_type: "resource"
        anomaly_strategy: "robust"

      ################################################################
      #                        Alerts                                #
      ################################################################

    - alert: AnomalyDetected
      for: 5m
      expr: >
        last_over_time(anomaly:level[2m]) < last_over_time(anomaly:lower_band[2m])
        or
        last_over_time(anomaly:level[2m]) > last_over_time(anomaly:upper_band[2m])
      labels:
        severity: warning
        saafe_severity: warning
        saafe_category: anomaly
